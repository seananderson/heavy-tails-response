---
title: "Observation error"
output: html_document
---

This file runs the models with a random walk and fixed observation error.

```{r}
library(dplyr)
library(rstan)
rstan_options(auto_write = TRUE)

if (!file.exists("stan-obs-rw.rds")) {
  stan_model_obs_rw <- stan_model(file = "rw-obs.stan") 
  saveRDS(stan_model_obs_rw, file = "stan-obs-rw.rds")
} else {
  stan_model_obs_rw <- readRDS("stan-obs-rw.rds")
}

gpdd <- readRDS("youngflesh-analysis/Data/gpdd-clean.rds")
load("generated-data/youngflesh.rda")
gpdd <- inner_join(gpdd, select(f_data, main_id, Rho, p10))

gpdd <- filter(gpdd, p10 > 0.5)
# length(unique(gpdd$main_id))

if (!file.exists("stan-obs-rw.rds")) {
  out <- lapply(unique(gpdd$main_id), function(ii) {
    x <- filter(gpdd, main_id == ii)
    m <- sampling(stan_model_obs_rw,
      data = list(N = nrow(x), y = log(x$population_untransformed), 
        sigma_obs = 0.2),
      iter = 2000, chains = 4, control = list(adapt_delta = 0.95))
    
    s <- rstan::extract(m, pars = "U")$U
    diff_m <- matrix(ncol = ncol(s) - 1, nrow = nrow(s))
    for (i in 2:ncol(s))
      diff_m[, i - 1] <- s[, i] - s[, i - 1]
    
    medians <- apply(diff_m, 2, median)
    max_id <- which(medians == max(medians))
    
    q <- as.data.frame(t(quantile(diff_m[, max_id],
      probs = c(0.025, 0.25, 0.5, 0.75, 0.975))))
    q$main_id <- ii
    list(r_max = q, U = s, max_diff_post = diff_m[, max_id])
  })
  saveRDS(out, file = "out.rds")
} else {
  out <- readRDS("out.rds")
}

rmax_obs <- plyr::ldply(out, function(x) x$r_max) %>%
  inner_join(select(f_data, main_id, Rho, p10, common_name, r_max)) %>%
  mutate(id = paste(common_name, main_id)) %>%
  mutate(dif = `50%` - Rho) %>%
  mutate(id = paste0(common_name, " / ", main_id)) %>%
  mutate(id = forcats::fct_reorder(id, dif))

ggplot(rmax_obs, aes(`50%`, id)) + geom_point() +
  geom_segment(aes(y = id, yend = id,
    x = `2.5%`, xend = `97.5%`)) +
  geom_point(aes(x = Rho), col = "red", pch = 3) +
  geom_point(aes(x = r_max), pch = 21) +
  ggsidekick::theme_sleek() +
  theme(panel.grid.major.y = element_line(colour = "grey90", linetype = 1)) +
  ylab("") + xlab("Maximum per-capita growth rate")
ggsave("rw-obs-maxr.pdf", width = 6, height = 5)

filter(rmax_obs, `50%` > Rho)
filter(rmax_obs, `25%` > Rho)
filter(rmax_obs, `2.5%` > Rho)

rmax_obs_p <- plyr::ldply(out, function(x) {
  p <- mean(x$max_diff_post < f_data$Rho[f_data$main_id == x$r_max$main_id[[1]]])
  data.frame(prob = p, main_id = x$r_max$main_id[[1]])
}) 
rmax_obs_p %>% arrange(prob)
filter(rmax_obs_p, prob < 0.5)

rmax_obs_p %>% arrange(prob)
filter(rmax_obs_p, prob < 0.5)

filter(rmax_obs, r_max > Rho)
```
